name: DigiWallet CI/CD

on:
  push:
    branches: [main, final_fsd]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Run Tests
        run: ./mvnw.cmd test

      - name: Build JAR
        run: ./mvnw.cmd package -DskipTests

      - name: Verify JAR exists
        run: |
          if (!(Test-Path "target\DigiWallet-0.0.1-SNAPSHOT.jar")) {
            Write-Error "JAR file not found!"
            exit 1
          }
          Write-Host "[OK] JAR file verified: target\DigiWallet-0.0.1-SNAPSHOT.jar"

      - name: Start Backend
        run: |
          # Create logs directory
          if (!(Test-Path "logs")) {
            New-Item -ItemType Directory -Path "logs" | Out-Null
          }
          
          Write-Host "Starting backend..."
          
          # Kill any existing java processes on port 8080
          $port8080 = Get-NetTCPConnection -LocalPort 8080 -ErrorAction SilentlyContinue
          if ($port8080) {
            Stop-Process -Id $port8080.OwningProcess -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 3
          }
          
          # Start backend using background job that persists
          $jarPath = Resolve-Path "target\DigiWallet-0.0.1-SNAPSHOT.jar"
          $logDir = Resolve-Path "logs"
          
          # Create a scheduled task to run the backend (persists beyond workflow)
          $action = New-ScheduledTaskAction -Execute "java" -Argument "-jar `"$jarPath`"" -WorkingDirectory (Get-Location)
          $trigger = New-ScheduledTaskTrigger -Once -At (Get-Date).AddSeconds(2)
          $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable
          
          # Remove existing task if exists
          Unregister-ScheduledTask -TaskName "DigiWallet-Backend" -Confirm:$false -ErrorAction SilentlyContinue
          
          # Register and start task
          Register-ScheduledTask -TaskName "DigiWallet-Backend" -Action $action -Trigger $trigger -Settings $settings -User "SYSTEM" | Out-Null
          Start-ScheduledTask -TaskName "DigiWallet-Backend"
          
          Write-Host "Backend scheduled task started"
          
          # Wait for backend to start (check port)
          $maxAttempts = 30
          $attempt = 0
          $backendReady = $false
          
          while ($attempt -lt $maxAttempts -and !$backendReady) {
            Start-Sleep -Seconds 2
            $attempt++
            Write-Host "Checking backend... attempt $attempt/$maxAttempts"
            
            try {
              $connection = Get-NetTCPConnection -LocalPort 8080 -State Listen -ErrorAction SilentlyContinue
              if ($connection) {
                $backendReady = $true
                Write-Host "[OK] Backend is listening on port 8080"
              }
            } catch {
              # Port not ready yet
            }
          }
          
          if (!$backendReady) {
            Write-Error "Backend failed to bind to port 8080 within 60 seconds"
            # Show task status
            Get-ScheduledTask -TaskName "DigiWallet-Backend" | Select-Object TaskName, State, LastRunTime, LastTaskResult
            exit 1
          }
          
          Write-Host "[OK] Backend successfully started on http://localhost:8080"

      - name: Start Frontend
        run: |
          Write-Host "Starting frontend..."
          
          # Kill any existing process on port 3000
          $port3000 = Get-NetTCPConnection -LocalPort 3000 -ErrorAction SilentlyContinue
          if ($port3000) {
            Stop-Process -Id $port3000.OwningProcess -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 2
          }
          
          # Start frontend using scheduled task
          $frontendPath = Resolve-Path "frontend"
          $httpServerScript = Join-Path $frontendPath "http-server.ps1"
          
          $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -File `"$httpServerScript`"" -WorkingDirectory $frontendPath
          $trigger = New-ScheduledTaskTrigger -Once -At (Get-Date).AddSeconds(2)
          $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable
          
          # Remove existing task if exists
          Unregister-ScheduledTask -TaskName "DigiWallet-Frontend" -Confirm:$false -ErrorAction SilentlyContinue
          
          # Register and start task
          Register-ScheduledTask -TaskName "DigiWallet-Frontend" -Action $action -Trigger $trigger -Settings $settings -User "SYSTEM" | Out-Null
          Start-ScheduledTask -TaskName "DigiWallet-Frontend"
          
          Write-Host "Frontend scheduled task started"
          
          # Wait for frontend to start
          $maxAttempts = 15
          $attempt = 0
          $frontendReady = $false
          
          while ($attempt -lt $maxAttempts -and !$frontendReady) {
            Start-Sleep -Seconds 2
            $attempt++
            Write-Host "Checking frontend... attempt $attempt/$maxAttempts"
            
            try {
              $connection = Get-NetTCPConnection -LocalPort 3000 -State Listen -ErrorAction SilentlyContinue
              if ($connection) {
                $frontendReady = $true
                Write-Host "[OK] Frontend is listening on port 3000"
              }
            } catch {
              # Port not ready yet
            }
          }
          
          if ($frontendReady) {
            Write-Host "[OK] Frontend successfully started on http://localhost:3000"
          } else {
            Write-Warning "Frontend may not have started correctly"
            Get-ScheduledTask -TaskName "DigiWallet-Frontend" | Select-Object TaskName, State, LastRunTime, LastTaskResult
          }
        continue-on-error: true

      - name: Deployment Summary
        if: success()
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "   DEPLOYMENT SUCCESSFUL" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "Backend:  http://localhost:8080"
          Write-Host "Frontend: http://localhost:3000"
          Write-Host "Swagger:  http://localhost:8080/swagger-ui.html"
          Write-Host ""
          Write-Host "Logs directory: logs/"
          Write-Host "  - backend.log"
          Write-Host "  - backend-error.log"
          Write-Host "  - frontend.log"
          Write-Host ""



