name: DigiWallet CI/CD

on:
  push:
    branches: [main, final_fsd]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Run Tests
        run: ./mvnw.cmd test

      - name: Build JAR
        run: ./mvnw.cmd package -DskipTests

      - name: Verify JAR exists
        run: |
          if (!(Test-Path "target\DigiWallet-0.0.1-SNAPSHOT.jar")) {
            Write-Error "JAR file not found!"
            exit 1
          }
          Write-Host "[OK] JAR file verified: target\DigiWallet-0.0.1-SNAPSHOT.jar"

      - name: Start Backend
        run: |
          # Create logs directory
          if (!(Test-Path "logs")) {
            New-Item -ItemType Directory -Path "logs" | Out-Null
          }
          
          Write-Host "Starting backend..."
          
          # Start backend as detached process
          $jarPath = Resolve-Path "target\DigiWallet-0.0.1-SNAPSHOT.jar"
          $logFile = Resolve-Path "logs" | Join-Path -ChildPath "backend.log"
          $errorFile = Resolve-Path "logs" | Join-Path -ChildPath "backend-error.log"
          
          Start-Process -FilePath "java" `
                       -ArgumentList "-jar","$jarPath" `
                       -RedirectStandardOutput $logFile `
                       -RedirectStandardError $errorFile `
                       -NoNewWindow `
                       -PassThru
          
          Write-Host "Backend process started"
          
          # Wait for backend to start (check port)
          $maxAttempts = 30
          $attempt = 0
          $backendReady = $false
          
          while ($attempt -lt $maxAttempts -and !$backendReady) {
            Start-Sleep -Seconds 2
            $attempt++
            Write-Host "Checking backend... attempt $attempt/$maxAttempts"
            
            try {
              $result = Test-NetConnection -ComputerName localhost -Port 8080 -InformationLevel Quiet -WarningAction SilentlyContinue
              if ($result) {
                $backendReady = $true
                Write-Host "[OK] Backend is listening on port 8080"
              }
            } catch {
              # Port not ready yet
            }
          }
          
          if (!$backendReady) {
            Write-Error "Backend failed to bind to port 8080 within 60 seconds"
            if (Test-Path $logFile) {
              Write-Host "=== Backend Log (last 50 lines) ==="
              Get-Content $logFile | Select-Object -Last 50
            }
            if (Test-Path $errorFile) {
              Write-Host "=== Backend Error Log ==="
              Get-Content $errorFile | Select-Object -Last 50
            }
            exit 1
          }
          
          Write-Host "[OK] Backend successfully started on http://localhost:8080"

      - name: Start Frontend
        run: |
          Write-Host "Starting frontend..."
          
          # Start frontend HTTP server
          $frontendPath = Resolve-Path "frontend"
          $httpServerScript = Join-Path $frontendPath "http-server.ps1"
          $logFile = Resolve-Path "logs" | Join-Path -ChildPath "frontend.log"
          
          Start-Process -FilePath "powershell" `
                       -ArgumentList "-ExecutionPolicy","Bypass","-File","$httpServerScript" `
                       -RedirectStandardOutput $logFile `
                       -NoNewWindow `
                       -PassThru
          
          Write-Host "Frontend process started"
          
          # Wait for frontend to start
          $maxAttempts = 15
          $attempt = 0
          $frontendReady = $false
          
          while ($attempt -lt $maxAttempts -and !$frontendReady) {
            Start-Sleep -Seconds 2
            $attempt++
            Write-Host "Checking frontend... attempt $attempt/$maxAttempts"
            
            try {
              $result = Test-NetConnection -ComputerName localhost -Port 3000 -InformationLevel Quiet -WarningAction SilentlyContinue
              if ($result) {
                $frontendReady = $true
                Write-Host "[OK] Frontend is listening on port 3000"
              }
            } catch {
              # Port not ready yet
            }
          }
          
          if ($frontendReady) {
            Write-Host "[OK] Frontend successfully started on http://localhost:3000"
          } else {
            Write-Warning "Frontend may not have started correctly (continuing anyway)"
            if (Test-Path $logFile) {
              Write-Host "=== Frontend Log ==="
              Get-Content $logFile
            }
          }
        continue-on-error: true

      - name: Deployment Summary
        if: success()
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "   DEPLOYMENT SUCCESSFUL" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "Backend:  http://localhost:8080"
          Write-Host "Frontend: http://localhost:3000"
          Write-Host "Swagger:  http://localhost:8080/swagger-ui.html"
          Write-Host ""
          Write-Host "Logs directory: logs/"
          Write-Host "  - backend.log"
          Write-Host "  - backend-error.log"
          Write-Host "  - frontend.log"
          Write-Host ""



